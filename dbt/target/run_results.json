{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.9", "generated_at": "2025-08-28T14:48:08.728296Z", "invocation_id": "d6f7e75b-e5ba-4ef8-aefa-ec6ff8e8b196", "invocation_started_at": "2025-08-28T14:48:05.062524Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.057584Z", "completed_at": "2025-08-28T14:48:08.129253Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.155619Z", "completed_at": "2025-08-28T14:48:08.297894Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.27115631103515625, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.stg_encounter", "compiled": true, "compiled_code": "select\n    id as fhir_id,\n    resource,\n    resource ->> 'id'                                 as resource_id,\n    resource ->> 'status'                             as status,\n    resource -> 'class' ->> 'code'                    as class_code,\n    resource -> 'type'  -> 0 -> 'coding' -> 0 ->> 'code'    as type_code,\n    resource -> 'type'  -> 0 -> 'coding' -> 0 ->> 'display' as type_display,\n\n    \n    -- ref_text looks like 'Patient/123' -> return '123'\n    (regexp_replace(resource -> 'subject' ->> 'reference', '^\\w+/', ''))\n as patient_id,\n    \n    -- ref_text looks like 'Patient/123' -> return '123'\n    (regexp_replace(resource -> 'participant' -> 0 -> 'individual' ->> 'reference', '^\\w+/', ''))\n as practitioner_id,\n\n    \n  (nullif(resource -> 'period' ->> 'start', '')::timestamptz)\n as period_start,\n    \n  (nullif(resource -> 'period' ->> 'end', '')::timestamptz)\n   as period_end,\n\n    \n  (nullif(\"lastUpdated\", '')::timestamptz)\n                    as lastUpdated_ts,\n    _airbyte_extracted_at\nfrom \"data_warehouse\".\"airbyte\".\"encounter\"", "relation_name": "\"data_warehouse\".\"engage_analytics_stg\".\"stg_encounter\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.052972Z", "completed_at": "2025-08-28T14:48:08.086083Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.086941Z", "completed_at": "2025-08-28T14:48:08.315693Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.28726959228515625, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.stg_patient", "compiled": true, "compiled_code": "with src as (\n    select\n        id as fhir_id,\n        resource,\n        resource ->> 'id'                  as resource_id,\n        resource -> 'meta' ->> 'versionId' as version_id,\n        resource -> 'meta' ->> 'lastUpdated' as meta_last_updated,\n        resource ->> 'gender'              as gender,\n        resource ->> 'birthDate'           as birth_date,\n        resource ->> 'active'              as active,\n\n        \n  (nullif(\"lastUpdated\", '')::timestamptz)\n as lastUpdated_ts,   -- << quote the column\n        _airbyte_extracted_at\n    from \"data_warehouse\".\"airbyte\".\"patient\"\n)\nselect * from src", "relation_name": "\"data_warehouse\".\"engage_analytics_stg\".\"stg_patient\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.048467Z", "completed_at": "2025-08-28T14:48:08.063950Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.065262Z", "completed_at": "2025-08-28T14:48:08.319100Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.2898871898651123, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.stg_practitioner", "compiled": true, "compiled_code": "select\n    id as fhir_id,\n    resource,\n    resource ->> 'id'                            as resource_id,\n    resource -> 'name' -> 0 ->> 'family'         as family_name,\n    resource -> 'name' -> 0 -> 'given' ->> 0     as given_name,\n    resource -> 'telecom' -> 0 ->> 'value'       as phone_raw,\n\n    \n  (nullif(\"lastUpdated\", '')::timestamptz)\n        as lastUpdated_ts,   -- << quote the column\n    _airbyte_extracted_at\nfrom \"data_warehouse\".\"airbyte\".\"practitioner\"", "relation_name": "\"data_warehouse\".\"engage_analytics_stg\".\"stg_practitioner\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.037458Z", "completed_at": "2025-08-28T14:48:08.064665Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.080941Z", "completed_at": "2025-08-28T14:48:08.331680Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.33340024948120117, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.stg_questionnaire_response", "compiled": true, "compiled_code": "with base as (\n    select\n        id as fhir_id,\n        resource,\n        resource ->> 'id'            as resource_id,\n        resource ->> 'status'        as status,\n        resource ->> 'questionnaire' as questionnaire_canonical,\n\n        \n    -- ref_text looks like 'Patient/123' -> return '123'\n    (regexp_replace(resource -> 'subject'   ->> 'reference', '^\\w+/', ''))\n as patient_id,\n        \n    -- ref_text looks like 'Patient/123' -> return '123'\n    (regexp_replace(resource -> 'encounter' ->> 'reference', '^\\w+/', ''))\n as encounter_id,\n        \n    -- ref_text looks like 'Patient/123' -> return '123'\n    (regexp_replace(resource -> 'author'    ->> 'reference', '^\\w+/', ''))\n as author_id,\n\n        \n  (nullif(resource ->> 'authored', '')::timestamptz)\n as authored_ts,\n        \n  (nullif(\"lastUpdated\", '')::timestamptz)\n           as lastUpdated_ts,\n        _airbyte_extracted_at\n    from \"data_warehouse\".\"airbyte\".\"questionnaire_response\"\n)\nselect * from base", "relation_name": "\"data_warehouse\".\"engage_analytics_stg\".\"stg_questionnaire_response\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.328240Z", "completed_at": "2025-08-28T14:48:08.328248Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.332204Z", "completed_at": "2025-08-28T14:48:08.479529Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.15863323211669922, "adapter_response": {"_message": "INSERT 4", "code": "INSERT", "rows_affected": 4}, "message": "INSERT 4", "failures": null, "unique_id": "seed.opensrp_mh.score_map", "compiled": null, "compiled_code": null, "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.369318Z", "completed_at": "2025-08-28T14:48:08.376691Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.385518Z", "completed_at": "2025-08-28T14:48:08.504181Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.1573798656463623, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.fact_encounter", "compiled": true, "compiled_code": "select\n  e.fhir_id as encounter_id,\n  e.patient_id,\n  e.practitioner_id,\n  e.status,\n  e.class_code,\n  e.type_code,\n  e.type_display,\n  e.period_start,\n  e.period_end\nfrom \"data_warehouse\".\"engage_analytics_stg\".\"stg_encounter\" e", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"fact_encounter\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.378790Z", "completed_at": "2025-08-28T14:48:08.396960Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.399584Z", "completed_at": "2025-08-28T14:48:08.514560Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.14483118057250977, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.dim_patient", "compiled": true, "compiled_code": "select\n  p.fhir_id as patient_id,\n  p.gender,\n  (p.birth_date)::date as birth_date,\n  (date_part('year', age((p.birth_date)::date)))::int as age_years,\n  (p.active)::boolean as is_active\nfrom \"data_warehouse\".\"engage_analytics_stg\".\"stg_patient\" p", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"dim_patient\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.392426Z", "completed_at": "2025-08-28T14:48:08.398603Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.404061Z", "completed_at": "2025-08-28T14:48:08.507697Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.12573599815368652, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.dim_practitioner", "compiled": true, "compiled_code": "select\n  pr.fhir_id as practitioner_id,\n  coalesce(pr.given_name || ' ', '') || coalesce(pr.family_name,'') as practitioner_name,\n  pr.phone_raw\nfrom \"data_warehouse\".\"engage_analytics_stg\".\"stg_practitioner\" pr", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"dim_practitioner\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.508995Z", "completed_at": "2025-08-28T14:48:08.518285Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.520746Z", "completed_at": "2025-08-28T14:48:08.581513Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.08183956146240234, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.int_qr_answers_long", "compiled": true, "compiled_code": "with qr as (\n  select * from \"data_warehouse\".\"engage_analytics_stg\".\"stg_questionnaire_response\"\n),\nitems as (\n  select\n    q.fhir_id as qr_id,\n    q.patient_id,\n    q.encounter_id,\n    q.author_id,\n    q.questionnaire_canonical,\n    q.authored_ts,\n    i ->> 'linkId' as link_id,\n    i ->> 'text'   as item_text,\n    a as answer\n  from qr q\n  left join lateral jsonb_array_elements(q.resource -> 'item') as i on true\n  left join lateral jsonb_array_elements(coalesce(i->'answer','[]'::jsonb)) as a on true\n),\nanswers as (\n  select\n    *,\n    case\n      when answer ? 'valueInteger' then (answer ->> 'valueInteger')::numeric\n      when answer ? 'valueDecimal' then (answer ->> 'valueDecimal')::numeric\n      when answer ? 'valueQuantity' then (answer -> 'valueQuantity' ->> 'value')::numeric\n      else null\n    end as value_num,\n    answer -> 'valueCoding' ->> 'code'    as value_code,\n    answer -> 'valueCoding' ->> 'display' as value_display,\n    answer ->> 'valueString'              as value_string,\n    answer ->> 'valueDate'                as value_date,\n    answer ->> 'valueBoolean'             as value_boolean\n  from items\n)\nselect * from answers", "relation_name": "\"data_warehouse\".\"engage_analytics_int\".\"int_qr_answers_long\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.539635Z", "completed_at": "2025-08-28T14:48:08.549473Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.550833Z", "completed_at": "2025-08-28T14:48:08.647542Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.11745715141296387, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.core_counts", "compiled": true, "compiled_code": "-- Basic counts / indicators\nwith a as (select count(*) as patients from \"data_warehouse\".\"engage_analytics_mart\".\"dim_patient\"),\nb as (select count(*) as practitioners from \"data_warehouse\".\"engage_analytics_mart\".\"dim_practitioner\"),\nc as (select count(*) as encounters from \"data_warehouse\".\"engage_analytics_mart\".\"fact_encounter\"),\nd as (\n    select practitioner_id, count(*) as encounters_per_practitioner\n    from \"data_warehouse\".\"engage_analytics_mart\".\"fact_encounter\"\n    group by 1\n)\nselect\n  a.patients,\n  b.practitioners,\n  c.encounters\nfrom a,b,c", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"core_counts\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.534380Z", "completed_at": "2025-08-28T14:48:08.544355Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.545006Z", "completed_at": "2025-08-28T14:48:08.650004Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.1192162036895752, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.patients_no_followup", "compiled": true, "compiled_code": "-- Patients who have no encounter beyond (at most) 1 total encounter\nwith ec as (\n  select patient_id, count(*) as encounter_count\n  from \"data_warehouse\".\"engage_analytics_mart\".\"fact_encounter\"\n  group by 1\n)\nselect p.patient_id\nfrom \"data_warehouse\".\"engage_analytics_mart\".\"dim_patient\" p\nleft join ec on ec.patient_id = p.patient_id\nwhere coalesce(ec.encounter_count,0) <= 1", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"patients_no_followup\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.608289Z", "completed_at": "2025-08-28T14:48:08.617613Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.623390Z", "completed_at": "2025-08-28T14:48:08.696390Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.09874844551086426, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.int_qr_answers_scored", "compiled": true, "compiled_code": "with a as (\n  select * from \"data_warehouse\".\"engage_analytics_int\".\"int_qr_answers_long\"\n),\nmap as (\n  select * from \"data_warehouse\".\"engage_analytics\".\"score_map\"\n)\nselect\n  a.*,\n  coalesce(\n    a.value_num,\n    case when a.value_code is not null then\n      (select m.numeric_value from map m\n       where a.link_id = m.link_id\n         and a.value_code = m.coding_code\n         and a.questionnaire_canonical ilike '%' || m.questionnaire_match || '%'\n       limit 1)\n    end\n  ) as score_value\nfrom a", "relation_name": "\"data_warehouse\".\"engage_analytics_int\".\"int_qr_answers_scored\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-08-28T14:48:08.603540Z", "completed_at": "2025-08-28T14:48:08.615090Z"}, {"name": "execute", "started_at": "2025-08-28T14:48:08.618696Z", "completed_at": "2025-08-28T14:48:08.698775Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.10512781143188477, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.opensrp_mh.fact_qr_latest_scores", "compiled": true, "compiled_code": "-- Example: compute latest numeric totals per questionnaire (e.g., PHQ-9 / GAD-7 / PCL-5 8)\n-- Assumes numeric answers; if coded answers are used, create a mapping table and join to resolve scores.\nwith scored as (\n  select\n    patient_id,\n    questionnaire_canonical,\n    authored_ts,\n    sum(coalesce(value_num, 0)) as total_score\n  from \"data_warehouse\".\"engage_analytics_int\".\"int_qr_answers_long\"\n  group by 1,2,3\n),\nlatest as (\n  select distinct on (patient_id, questionnaire_canonical)\n    patient_id,\n    questionnaire_canonical,\n    authored_ts,\n    total_score\n  from scored\n  order by patient_id, questionnaire_canonical, authored_ts desc\n)\nselect * from latest", "relation_name": "\"data_warehouse\".\"engage_analytics_mart\".\"fact_qr_latest_scores\"", "batch_results": null}], "elapsed_time": 1.0535261631011963, "args": {"print": true, "require_yaml_configuration_for_mf_time_spines": false, "require_nested_cumulative_type_params": false, "write_json": true, "require_generic_test_arguments_property": true, "send_anonymous_usage_stats": true, "include_saved_query": false, "log_format_file": "debug", "require_all_warnings_handled_by_warn_error": false, "select": [], "static_parser": true, "require_resource_names_without_spaces": true, "indirect_selection": "eager", "resource_types": [], "require_explicit_package_overrides_for_builtin_materializations": true, "show": false, "cache_selected_only": false, "state_modified_compare_more_unrendered_values": false, "invocation_command": "dbt build", "export_saved_queries": false, "log_format": "default", "project_dir": "/home/dbt/fhir-analytics-repo/engage-analytics/dbt", "log_path": "/home/dbt/fhir-analytics-repo/engage-analytics/dbt/logs", "use_fast_test_edges": false, "profiles_dir": "/home/dbt/.dbt", "state_modified_compare_vars": false, "validate_macro_args": false, "exclude": [], "quiet": false, "partial_parse_file_diff": true, "populate_cache": true, "favor_state": false, "which": "build", "empty": false, "exclude_resource_types": [], "skip_nodes_if_on_run_start_fails": false, "macro_debugging": false, "require_batched_execution_for_custom_microbatch_strategy": false, "defer": false, "vars": {}, "partial_parse": true, "log_level_file": "debug", "strict_mode": false, "log_file_max_bytes": 10485760, "show_all_deprecations": false, "target": "prod", "upload_to_artifacts_ingest_api": false, "log_level": "info", "printer_width": 80, "show_resource_report": false, "source_freshness_run_project_hooks": true, "use_colors_file": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "use_colors": true, "version_check": true, "introspect": true}}