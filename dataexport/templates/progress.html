{% extends "base.html" %}

{% block title %}Exporting Data - Engage Analytics{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body p-5">
                <h2 class="card-title text-center mb-4">
                    <i class="fas fa-cog fa-spin text-primary"></i> Preparing Export
                </h2>
                
                <div class="progress mb-3" style="height: 30px;">
                    <div id="progressBar" 
                         class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%">
                        0%
                    </div>
                </div>
                
                <div id="statusMessage" class="alert alert-info">
                    <i class="fas fa-hourglass-start"></i> Initializing export process...
                </div>
                
                <div id="exportDetails" class="mt-4" style="display: none;">
                    <h5>Export Progress:</h5>
                    <ul id="progressLog" class="list-group">
                    </ul>
                </div>
                
                <div id="downloadSection" class="text-center mt-4" style="display: none;">
                    <h4 class="text-success mb-3">
                        <i class="fas fa-check-circle"></i> Export Complete!
                    </h4>
                    <a href="{{ url_for('download_file') }}" class="btn btn-success btn-lg">
                        <i class="fas fa-download"></i> Download Export
                    </a>
                    <hr class="my-4">
                    <a href="{{ url_for('download_form') }}" class="btn btn-link">
                        <i class="fas fa-redo"></i> Start New Export
                    </a>
                </div>
                
                <div id="errorSection" class="alert alert-danger mt-4" style="display: none;">
                    <h5><i class="fas fa-exclamation-triangle"></i> Export Failed</h5>
                    <p id="errorMessage"></p>
                    <a href="{{ url_for('download_form') }}" class="btn btn-warning">
                        <i class="fas fa-arrow-left"></i> Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const exportId = "{{ export_id }}";
const progressBar = document.getElementById('progressBar');
const statusMessage = document.getElementById('statusMessage');
const progressLog = document.getElementById('progressLog');
const exportDetails = document.getElementById('exportDetails');
const downloadSection = document.getElementById('downloadSection');
const errorSection = document.getElementById('errorSection');
const errorMessage = document.getElementById('errorMessage');

let lastProgress = 0;
let pollingInterval = null;

// Function to complete the export
function completeExport() {
    // Hide the progress bar and "Preparing Export" title
    document.querySelector('.card-title').style.display = 'none';
    document.querySelector('.progress').style.display = 'none';
    statusMessage.style.display = 'none';
    exportDetails.style.display = 'none';
    
    // Show the download section
    downloadSection.style.display = 'block';
    
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    
    // Ensure event source is closed
    if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        eventSource.close();
    }
}

// Polling function to check status
function pollExportStatus() {
    // If already completed, don't poll
    if (downloadSection.style.display !== 'none') {
        return;
    }
    
    fetch(`/api/export-status/${exportId}`)
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            // If 404 or error, just complete if we're at 95%
            if (lastProgress >= 95) {
                completeExport();
            }
            return null;
        })
        .then(data => {
            if (data && data.status === 'complete' && data.download_ready) {
                completeExport();
            } else if (lastProgress >= 95) {
                // If we're at 95% but status check fails, just complete it
                completeExport();
            }
        })
        .catch(error => {
            console.error('Error polling status:', error);
            // On any error at 95%, just complete
            if (lastProgress >= 95) {
                completeExport();
            }
        });
}

// Start polling after 5 seconds as a backup
setTimeout(() => {
    pollingInterval = setInterval(pollExportStatus, 2000);
}, 5000);

// Start server-sent events connection
const eventSource = new EventSource(`/export-progress/${exportId}`);

eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    // Update progress bar
    if (data.progress !== undefined) {
        lastProgress = data.progress;
        progressBar.style.width = data.progress + '%';
        progressBar.textContent = data.progress + '%';
    }
    
    // Update status message
    if (data.message) {
        statusMessage.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${data.message}`;
        
        // Add to progress log
        if (data.progress > 10) {
            exportDetails.style.display = 'block';
            const logItem = document.createElement('li');
            logItem.className = 'list-group-item';
            logItem.innerHTML = `<i class="fas fa-check text-success"></i> ${data.message}`;
            progressLog.appendChild(logItem);
        }
        
        // If we see "Zip file created successfully!" at 95%, immediately complete
        if (data.message.includes('Zip file created successfully') && lastProgress >= 95) {
            setTimeout(() => {
                completeExport();
            }, 500);
        }
    }
    
    // Handle completion
    if (data.complete) {
        eventSource.close();
        completeExport();
    }
    
    // Handle errors
    if (data.error) {
        eventSource.close();
        progressBar.classList.remove('progress-bar-animated');
        statusMessage.style.display = 'none';
        errorSection.style.display = 'block';
        errorMessage.textContent = data.message || 'An unexpected error occurred during export.';
        
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
    }
};

eventSource.onerror = function(error) {
    console.error('EventSource error:', error);
    // Don't close immediately, try polling instead
    setTimeout(() => {
        pollExportStatus();
    }, 1000);
};

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    eventSource.close();
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
</script>
{% endblock %}